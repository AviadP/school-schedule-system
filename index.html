<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת שעות אינטראקטיבית - גרסה מתוקנת</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .instructions {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .button-group {
            margin: 20px 0;
            text-align: center;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        #processBtn {
            background-color: #2196F3;
        }
        #processBtn:hover {
            background-color: #0976d2;
        }
        #clearBtn {
            background-color: #f44336;
        }
        #clearBtn:hover {
            background-color: #da190b;
        }
        #debugBtn {
            background-color: #ff9800;
        }
        #debugBtn:hover {
            background-color: #e68900;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
            position: relative;
        }
        th {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
        }
        .time-cell {
            background-color: #e8f5e9;
            font-weight: bold;
        }
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
        }
        select.selected {
            background-color: #fff3e0;
            font-weight: bold;
        }
        select.synced {
            background-color: #e8f5e9;
            border: 2px solid #4CAF50;
        }
        #output {
            margin-top: 20px;
            display: none;
        }
        .stats {
            background-color: #fff3e0;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .legend {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-box {
            width: 20px;
            height: 20px;
            border: 1px solid #ddd;
        }
        .selected-box {
            background-color: #fff3e0;
        }
        .synced-box {
            background-color: #e8f5e9;
            border: 2px solid #4CAF50;
        }
        #debugInfo {
            background-color: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🕐 מערכת שעות אינטראקטיבית - גרסה מתוקנת</h1>
        
        <div class="instructions">
            <h3>הוראות שימוש:</h3>
            <ol>
                <li>לחץ על "צור מערכת" כדי ליצור טבלה עם תפריטים נפתחים</li>
                <li>בחר שיעורים מהתפריטים - שיעורים זהים (אותו שם, מורה ווריאנט) יסומנו אוטומטית</li>
                <li>המערכת תזהה התנגשויות ותאפשר לך לבחור אם להחליף או לשמור את הקיים</li>
                <li>רקע כתום = נבחר ידנית | רקע ירוק = סונכרן אוטומטית</li>
                <li>השתמש ב"נקה בחירות" כדי להתחיל מחדש</li>
                <li>לחץ על "ייצא לאקסל" כדי להוריד את המערכת שבחרת</li>
            </ol>
        </div>

        <div class="button-group">
            <button id="processBtn">צור מערכת</button>
            <button id="clearBtn" style="display:none;">נקה בחירות</button>
            <button id="exportBtn" style="display:none;">ייצא לאקסל</button>
            <button id="debugBtn" style="display:none;">הצג מידע דיבאג</button>
        </div>

        <div id="debugInfo"></div>

        <div class="legend" style="display:none;">
            <div class="legend-item">
                <div class="legend-box selected-box"></div>
                <span>נבחר ידנית</span>
            </div>
            <div class="legend-item">
                <div class="legend-box synced-box"></div>
                <span>סונכרן אוטומטית</span>
            </div>
        </div>

        <div id="stats" class="stats" style="display:none;">
            <h3>סטטיסטיקות:</h3>
            <p id="statsContent"></p>
        </div>

        <div id="output">
            <h2>מערכת שעות - בחר שיעורים מהתפריטים:</h2>
            <div id="tableContainer"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // נתונים מתוקנים - כל השיעורים עודכנו
        const fullScheduleData = {
            "08:30-09:20": { // שיעור 1
                "א": [
                    {course: "מפגשים ג'", variant: "1", teacher: "רובי"},
                    {course: "מפגשים ג'", variant: "2", teacher: "ורד"},
                    {course: "מפגשים ד'", variant: "1", teacher: "יובל"},
                    {course: "מפגשים ד'", variant: "2", teacher: "פאטמה"},
                    {course: "מפגשים ד'", variant: "3", teacher: "מורן"},
                    {course: "ספרייה", variant: "", teacher: "חלי"}
                ],
                "ב": [
                    {course: "אנגלית 2", variant: "1", teacher: "מיכל"},
                    {course: "אנגלית 2", variant: "3", teacher: "הלל"},
                    {course: "ברחובות שלנו", variant: "2", teacher: "שחר"},
                    {course: "מהמטבח באהבה", variant: "", teacher: "הדר"},
                    {course: "ספרייה", variant: "", teacher: "חלי"},
                    {course: "עברית 1", variant: "1", teacher: "רובי"},
                    {course: "צ'פלין ג-ד", variant: "", teacher: "אוהד"}
                ],
                "ג": [
                    {course: "חשבון 2", variant: "1", teacher: "אודליה"},
                    {course: "מפגשים ג'", variant: "1", teacher: "רובי"},
                    {course: "מפגשים ג'", variant: "2", teacher: "ורד"},
                    {course: "עברית 2", variant: "2", teacher: "מורן"}
                ],
                "ד": [
                    {course: "פרלמנט/שעה דמוקרטית", variant: "", teacher: ""}
                ],
                "ה": [
                    {course: "גינה ג-ד", variant: "", teacher: "מאיה"},
                    {course: "הדברים הסמויים מהעין", variant: "2", teacher: "ורד"},
                    {course: "חשבון 1", variant: "2", teacher: "אודליה"},
                    {course: "חשבון 2", variant: "2", teacher: "פאטמה"},
                    {course: "ספרייה", variant: "", teacher: "חלי"},
                    {course: "עברית 2", variant: "3", teacher: "מורן"}
                ],
                "ו": [
                    {course: "חליליות", variant: "1", teacher: "יובל"},
                    {course: "חשבון 1", variant: "1", teacher: "אודליה"},
                    {course: "חשבון 2", variant: "3", teacher: "אסף"},
                    {course: "מסע פנימה ג-ד", variant: "", teacher: "בת-אל"},
                    {course: "אנגלית 1", variant: "2", teacher: "מיכל"}
                ]
            },
            "09:25-10:10": { // שיעור 2
                "א": [
                    {course: "אומנות ג-ד", variant: "1", teacher: "מורן"},
                    {course: "ברחובות שלנו", variant: "1", teacher: "שחר"},
                    {course: "הדברים הסמויים מהעין", variant: "1", teacher: "ורד"},
                    {course: "חשבון 2", variant: "3", teacher: "אסף"},
                    {course: "סביבה וקיימות ג-ו", variant: "1", teacher: "רובי"},
                    {course: "עברית 1", variant: "2", teacher: "חלי"}
                ],
                "ב": [
                    {course: "ארבע קצוות תבל - מיתולוגיות ותרבויות מהע", variant: "", teacher: "אוהד"},
                    {course: "ברחובות שלנו", variant: "2", teacher: "שחר"},
                    {course: "חשבון 2", variant: "3", teacher: "אסף"},
                    {course: "מהמטבח באהבה", variant: "", teacher: "הדר"},
                    {course: "ספרייה", variant: "", teacher: "חלי"},
                    {course: "עברית 2", variant: "1", teacher: "מורן"}
                ],
                "ג": [
                    {course: "שעת חיבורים", variant: "", teacher: ""}
                ],
                "ד": [
                    {course: "אנגלית 2", variant: "1", teacher: "מיכל"},
                    {course: "חשבון 1", variant: "2", teacher: "אודליה"},
                    {course: "חשבון 2", variant: "2", teacher: "פאטמה"},
                    {course: "מהנדסי הדור הבא ג-ד", variant: "1", teacher: "חיצוני"},
                    {course: "עברית 1", variant: "1", teacher: "רובי"},
                    {course: "קומפוזיציה ג-ד", variant: "", teacher: "אורי"}
                ],
                "ה": [
                    {course: "הדברים הסמויים מהעין", variant: "2", teacher: "ורד"},
                    {course: "חשבון 2", variant: "1", teacher: "אודליה"},
                    {course: "כניסה לעולם המוסיקה ג-ד", variant: "", teacher: "אורי"},
                    {course: "ספרייה", variant: "", teacher: "חלי"},
                    {course: "עברית 2", variant: "2", teacher: "מורן"},
                    {course: "ערבית ג-ד", variant: "", teacher: "הייא"}
                ],
                "ו": [
                    {course: "הרכב קולי ג-ד", variant: "", teacher: "יובל"},
                    {course: "כדורגל בנים ג-ד", variant: "", teacher: "נועם"},
                    {course: "מסביב לעולם ג-ד", variant: "2", teacher: "איידה"},
                    {course: "תאטרון ג-ד", variant: "", teacher: "עומרי"},
                    {course: "אנגלית 1", variant: "1", teacher: "מיכל"}
                ]
            },
            "10:35-11:20": { // שיעור 3
                "א": [
                    {course: "אומנות ג-ד", variant: "1", teacher: "מורן"},
                    {course: "ברחובות שלנו", variant: "1", teacher: "שחר"},
                    {course: "הדברים הסמויים מהעין", variant: "1", teacher: "ורד"},
                    {course: "סביבה וקיימות ג-ו", variant: "1", teacher: "רובי"},
                    {course: "עברית 1", variant: "2", teacher: "חלי"},
                    {course: "עץ וטבע ג-ד", variant: "", teacher: "בני"}
                ],
                "ב": [
                    {course: "אנגלית 1", variant: "1", teacher: "מיכל"},
                    {course: "ביטבוקס ג-ד", variant: "", teacher: "אורי"},
                    {course: "ברחובות שלנו", variant: "2", teacher: "שחר"},
                    {course: "חשיבה יצירתית ג-ד", variant: "", teacher: "אוהד"},
                    {course: "מהמטבח באהבה", variant: "", teacher: "הדר"},
                    {course: "ספרייה", variant: "", teacher: "חלי"},
                    {course: "עברית 2", variant: "3", teacher: "מורן"}
                ],
                "ג": [
                    {course: "שעת ועדות", variant: "", teacher: ""}
                ],
                "ד": [
                    {course: "אנגלית 2", variant: "2", teacher: "מיכל"},
                    {course: "אנגלית 2", variant: "3", teacher: "הלל"},
                    {course: "חשבון 2", variant: "1", teacher: "אודליה"},
                    {course: "מפגשים ג'", variant: "1", teacher: "רובי"},
                    {course: "מפגשים ג'", variant: "2", teacher: "ורד"}
                ],
                "ה": [
                    {course: "הדברים הסמויים מהעין", variant: "2", teacher: "ורד"},
                    {course: "יהדות תורה ומה שביניהם ג-ד", variant: "", teacher: "נחשון"},
                    {course: "מפגשים ד'", variant: "1", teacher: "יובל"},
                    {course: "מפגשים ד'", variant: "2", teacher: "פאטמה"},
                    {course: "מפגשים ד'", variant: "3", teacher: "מורן"},
                    {course: "ספרייה", variant: "", teacher: "חלי"}
                ],
                "ו": [
                    {course: "כדורגל בנות ג-ו", variant: "", teacher: "נועם"},
                    {course: "תאטרון ג-ד", variant: "", teacher: "עומרי"},
                    {course: "אנגלית 2", variant: "2", teacher: "מיכל"},
                    {course: "חליליות", variant: "2", teacher: "יובל"},
                    {course: "חשבון 2", variant: "1", teacher: "אודליה"}
                ]
            },
            "11:30-12:15": { // שיעור 4
                "א": [
                    {course: "P.B.L", variant: "", teacher: "רובי"},
                    {course: "ברחובות שלנו", variant: "1", teacher: "שחר"},
                    {course: "הדברים הסמויים מהעין", variant: "1", teacher: "ורד"},
                    {course: "ההיסטוריה של הילדים והילדות ג-ו", variant: "1", teacher: "חלי"},
                    {course: "חשבון 2", variant: "2", teacher: "פאטמה"}
                ],
                "ב": [
                    {course: "אומנות מהטבע ג-ד", variant: "", teacher: "רובי"},
                    {course: "אנגלית 1", variant: "2", teacher: "מיכל"},
                    {course: "הסיפור של הסיפור ג-ד", variant: "", teacher: "חלי"},
                    {course: "מסביב לעולם ג-ד", variant: "1", teacher: "איידה"},
                    {course: "עברית 2", variant: "2", teacher: "מורן"},
                    {course: "תרבות יפן", variant: "", teacher: "אוהד"}
                ],
                "ג": [
                    {course: "מפגשים ד'", variant: "1", teacher: "יובל"},
                    {course: "מפגשים ד'", variant: "2", teacher: "פאטמה"},
                    {course: "מפגשים ד'", variant: "3", teacher: "מורן"},
                    {course: "עברית 1", variant: "1", teacher: "רובי"},
                    {course: "חשבון 1", variant: "2", teacher: "אודליה"}
                ],
                "ד": [
                    {course: "ביודנסה ג-ד", variant: "", teacher: "ורד"},
                    {course: "ההיסטוריה של הילדים והילדות ג-ו", variant: "2", teacher: "חלי"},
                    {course: "כדורגל בנים ג-ד", variant: "", teacher: "נועם"},
                    {course: "סביבה וקיימות ג-ו", variant: "2", teacher: "רובי"},
                    {course: "אנגלית 1", variant: "1", teacher: "מיכל"}
                ],
                "ה": [
                    {course: "תאטרון בובות", variant: "", teacher: "בני"},
                    {course: "אתגרי חשיבה ג-ד", variant: "", teacher: "הייא"},
                    {course: "חשבון 2", variant: "3", teacher: "אסף"},
                    {course: "משחקי עבר ועתיד ג-ד", variant: "2", teacher: "נועם"},
                    {course: "ספרייה", variant: "", teacher: "חלי"},
                    {course: "עברית 2", variant: "1", teacher: "מורן"}
                ],
                "ו": [
                    {course: "אנגלית 2", variant: "1", teacher: "מיכל"},
                    {course: "אנגלית 2", variant: "3", teacher: "הלל"},
                    {course: "ג'ודו ג-ד", variant: "", teacher: "גילי"},
                    {course: "חשבון 1", variant: "2", teacher: "אודליה"},
                    {course: "סודות היקום ג-ד", variant: "", teacher: "איידה"}
                ]
            },
            "12:30-13:15": { // שיעור 5
                "א": [
                    {course: "P.B.L", variant: "", teacher: "רובי"},
                    {course: "ההיסטוריה של הילדים והילדות ג-ו", variant: "1", teacher: "חלי"},
                    {course: "חשיבה פיננסית ג-ד", variant: "", teacher: "פאטמה"},
                    {course: "יוצרים בעץ ג-ד", variant: "1", teacher: "בני"},
                    {course: "לרקוד ועוד ג'-ד'", variant: "", teacher: "לילך"},
                    {course: "עברית 2", variant: "3", teacher: "מורן"}
                ],
                "ב": [
                    {course: "אומנות מהטבע ג-ד", variant: "", teacher: "רובי"},
                    {course: "אנגלית 2", variant: "2", teacher: "מיכל"},
                    {course: "גינה ג-ד", variant: "", teacher: "מאיה"},
                    {course: "יוצרים בעץ ג-ד", variant: "2", teacher: "בני"},
                    {course: "משחקי עבר ועתיד ג-ד", variant: "1", teacher: "נועם"},
                    {course: "עברית 1", variant: "2", teacher: "חלי"},
                    {course: "צ'פלין וחשיבה יצירתית המשך ג-ד", variant: "", teacher: "אוהד"}
                ],
                "ג": [
                    {course: "אנגלית 1", variant: "2", teacher: "מיכל"},
                    {course: "חשבון 1", variant: "1", teacher: "אודליה"},
                    {course: "חשבון 2", variant: "2", teacher: "פאטמה"},
                    {course: "לאכול בריא, לנשום, לנוע ג-ד", variant: "", teacher: "הדר"},
                    {course: "עברית 2", variant: "1", teacher: "מורן"}
                ],
                "ד": [
                    {course: "ההיסטוריה של הילדים והילדות ג-ו", variant: "2", teacher: "חלי"},
                    {course: "חשבון 1", variant: "1", teacher: "אודליה"},
                    {course: "כדורגל בנות ג-ו", variant: "", teacher: "נועם"},
                    {course: "מהנדסי הדור הבא ג-ד", variant: "2", teacher: "חיצוני"},
                    {course: "סביבה וקיימות ג-ו", variant: "2", teacher: "רובי"}
                ],
                "ה": [
                    {course: "חשיבה פיננסית ג-ד", variant: "", teacher: "פאטמה"},
                    {course: "ספרייה", variant: "", teacher: "חלי"},
                    {course: "קומיקס ג-ד", variant: "", teacher: "מורן"},
                    {course: "תאטרון בובות", variant: "", teacher: "בני"},
                    {course: "הרכב קולי ג-ד", variant: "", teacher: "יובל"},
                    {course: "חשבון 1", variant: "1", teacher: "אודליה"}
                ],
                "ו": []
            },
            "13:30-14:15": { // שיעור 6
                "א": [],
                "ב": [
                    {course: "אנגלית מתקדמים ג-ד", variant: "", teacher: "הלל"}
                ],
                "ג": [],
                "ד": [
                    {course: "מרכז אנגלית ג-ד", variant: "", teacher: "מיכל"}
                ],
                "ה": [],
                "ו": []
            }
        };

        let selectedCourses = {};
        let variantMap = {};

        // פונקציה ליצירת וריאנטים
        function createVariantMap() {
            variantMap = {};
            let variantCounter = 200;
            let libraryCounter = 1000;
            
            Object.keys(fullScheduleData).forEach(time => {
                Object.keys(fullScheduleData[time]).forEach(day => {
                    fullScheduleData[time][day].forEach(option => {
                        const key = `${option.course}_${option.teacher}`;
                        
                        // טיפול מיוחד בספרייה
                        if (option.course === "ספרייה" || option.course === "ספריה") {
                            option.variant = (libraryCounter++).toString();
                        } else if (!option.variant || option.variant === "") {
                            if (!variantMap[key]) {
                                variantMap[key] = variantCounter++;
                            }
                            option.variant = variantMap[key].toString();
                        }
                    });
                });
            });
        }

        // פונקציה למציאת כל המיקומים של שיעור מסוים
        function findAllCourseLocations(course, variant, teacher) {
            const locations = [];
            const timeSlots = Object.keys(fullScheduleData);
            const days = ['א', 'ב', 'ג', 'ד', 'ה', 'ו'];
            
            timeSlots.forEach((time, timeIndex) => {
                days.forEach((day, dayIndex) => {
                    const options = fullScheduleData[time][day] || [];
                    options.forEach(option => {
                        if (option.course === course && 
                            option.variant === variant && 
                            option.teacher === teacher) {
                            locations.push({
                                time: time,
                                day: day,
                                timeIndex: timeIndex,
                                dayIndex: dayIndex
                            });
                        }
                    });
                });
            });
            
            return locations;
        }

        // פונקציה לבדיקת התנגשויות - מתוקנת!
        function checkForConflicts(course, variant, teacher, currentTime, currentDay) {
            const conflicts = [];
            
            Object.keys(selectedCourses).forEach(key => {
                const [time, day] = key.split('_');
                const selected = selectedCourses[key];
                
                // התנגשות: אותו מורה באותה שעה בימים שונים (רק אם המורה לא ריק)
                if (time === currentTime && day !== currentDay && 
                    selected.teacher === teacher && teacher !== '' && teacher !== undefined) {
                    
                    // וודא שזה לא אותו שיעור עם אותו וריאנט (שזה בעצם סנכרון לגיטימי)
                    if (!(selected.course === course && selected.variant === variant)) {
                        conflicts.push({
                            course: selected.course,
                            teacher: selected.teacher,
                            time: time,
                            day: day,
                            type: 'teacher'
                        });
                    }
                }
            });
            
            return conflicts;
        }

        // פונקציה ליצירת הטבלה
        function createScheduleTable() {
            createVariantMap();
            
            let html = '<table>';
            html += '<thead><tr>';
            html += '<th>שעה</th>';
            html += '<th>יום ראשון</th>';
            html += '<th>יום שני</th>';
            html += '<th>יום שלישי</th>';
            html += '<th>יום רביעי</th>';
            html += '<th>יום חמישי</th>';
            html += '<th>יום שישי</th>';
            html += '</tr></thead>';
            html += '<tbody>';
            
            const dayMapping = {
                'א': 0, 'ב': 1, 'ג': 2, 'ד': 3, 'ה': 4, 'ו': 5
            };
            
            Object.keys(fullScheduleData).forEach((time, timeIndex) => {
                html += '<tr>';
                html += `<td class="time-cell">${time}</td>`;
                
                ['א', 'ב', 'ג', 'ד', 'ה', 'ו'].forEach(day => {
                    const dayId = dayMapping[day];
                    const options = fullScheduleData[time][day] || [];
                    const cellId = `cell_${timeIndex}_${dayId}`;
                    
                    if (options.length === 0) {
                        html += '<td>-</td>';
                    } else {
                        html += '<td>';
                        html += `<select id="${cellId}" data-time="${time}" data-day="${day}">`;
                        html += '<option value="">-- בחר שיעור --</option>';
                        
                        options.forEach(option => {
                            const value = `${option.course}|${option.variant}|${option.teacher}`;
                            const display = option.teacher ? 
                                `${option.course} (${option.variant}) - ${option.teacher}` :
                                `${option.course} (${option.variant})`;
                            html += `<option value="${value}">${display}</option>`;
                        });
                        
                        html += '</select>';
                        html += '</td>';
                    }
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            document.getElementById('tableContainer').innerHTML = html;
            
            // הוסף event listeners
            document.querySelectorAll('select').forEach(select => {
                select.addEventListener('change', handleSelectionChange);
            });
        }

        // פונקציה לטיפול בבחירה - גרסה פשוטה יותר
        function handleSelectionChange(event) {
            const select = event.target;
            const time = select.getAttribute('data-time');
            const day = select.getAttribute('data-day');
            const value = select.value;
            const key = `${time}_${day}`;
            
            // אם ביטלו בחירה
            if (!value) {
                // מחק את הבחירה הנוכחית
                const wasSelected = selectedCourses[key];
                delete selectedCourses[key];
                select.className = '';
                
                // אם היה שיעור שנבחר, בדוק אם צריך לנקות סנכרונים
                if (wasSelected) {
                    clearSyncedCourses(wasSelected.course, wasSelected.variant, wasSelected.teacher);
                }
                
                updateStats();
                return;
            }
            
            const [course, variant, teacher] = value.split('|');
            
            // בדוק התנגשויות
            const conflicts = checkForConflicts(course, variant, teacher, time, day);
            
            if (conflicts.length > 0) {
                let message = `השיעור "${course}" עם ${teacher} מתנגש עם:\n\n`;
                conflicts.forEach(conflict => {
                    const dayNames = {
                        'א': 'יום ראשון',
                        'ב': 'יום שני', 
                        'ג': 'יום שלישי',
                        'ד': 'יום רביעי',
                        'ה': 'יום חמישי',
                        'ו': 'יום שישי'
                    };
                    message += `• ${conflict.course} עם ${conflict.teacher} ב${dayNames[conflict.day]} בשעה ${conflict.time}\n`;
                });
                message += `\nהאם ברצונך להחליף את השיעורים הקיימים בשיעור החדש?`;
                
                if (!confirm(message)) {
                    select.value = '';
                    return;
                }
                
                // מחק את השיעורים המתנגשים
                conflicts.forEach(conflict => {
                    const conflictKey = `${conflict.time}_${conflict.day}`;
                    const conflictSelect = document.querySelector(`select[data-time="${conflict.time}"][data-day="${conflict.day}"]`);
                    if (conflictSelect) {
                        conflictSelect.value = '';
                        conflictSelect.className = '';
                        delete selectedCourses[conflictKey];
                    }
                });
            }
            
            // שמור את הבחירה
            selectedCourses[key] = {
                course, variant, teacher, manual: true
            };
            select.className = 'selected';
            
            // סנכרן את כל המיקומים של השיעור הזה
            syncAllCourseLocations(course, variant, teacher, key);
            
            updateStats();
            showDebugInfo();
        }

        // פונקציה לסנכרון כל המיקומים של שיעור
        function syncAllCourseLocations(course, variant, teacher, originalKey) {
            const locations = findAllCourseLocations(course, variant, teacher);
            
            console.log(`מסנכרן ${course} (${variant}) עם ${teacher}`);
            console.log(`נמצאו ${locations.length} מיקומים:`, locations);
            
            locations.forEach(loc => {
                const locKey = `${loc.time}_${loc.day}`;
                
                // דלג על המיקום המקורי
                if (locKey === originalKey) return;
                
                // בדוק התנגשויות
                const conflicts = checkForConflicts(course, variant, teacher, loc.time, loc.day);
                if (conflicts.length > 0) {
                    console.log(`דילוג על סנכרון ב-${loc.day} ${loc.time} בגלל התנגשות`);
                    return;
                }
                
                // בצע סנכרון
                const cellId = `cell_${loc.timeIndex}_${loc.dayIndex}`;
                const selectElement = document.getElementById(cellId);
                
                if (selectElement) {
                    const value = `${course}|${variant}|${teacher}`;
                    selectElement.value = value;
                    selectElement.className = 'synced';
                    
                    selectedCourses[locKey] = {
                        course, variant, teacher, manual: false
                    };
                    
                    console.log(`סונכרן: ${loc.day} ${loc.time}`);
                }
            });
        }

        // פונקציה לניקוי סנכרונים של שיעור מסוים
        function clearSyncedCourses(course, variant, teacher) {
            Object.keys(selectedCourses).forEach(key => {
                const selected = selectedCourses[key];
                if (!selected.manual && 
                    selected.course === course && 
                    selected.variant === variant && 
                    selected.teacher === teacher) {
                    
                    const [time, day] = key.split('_');
                    const select = document.querySelector(`select[data-time="${time}"][data-day="${day}"]`);
                    if (select) {
                        select.value = '';
                        select.className = '';
                    }
                    delete selectedCourses[key];
                }
            });
        }

        // פונקציה לעדכון סטטיסטיקות
        function updateStats() {
            const manualCount = Object.values(selectedCourses).filter(s => s.manual).length;
            const syncedCount = Object.values(selectedCourses).filter(s => !s.manual).length;
            
            let uniqueCourses = new Set();
            Object.values(selectedCourses).forEach(course => {
                uniqueCourses.add(`${course.course}_${course.variant}`);
            });
            
            document.getElementById('statsContent').innerHTML = `
                <strong>בחירות ידניות:</strong> ${manualCount}<br>
                <strong>סונכרנו אוטומטית:</strong> ${syncedCount}<br>
                <strong>סה"כ משבצות מלאות:</strong> ${manualCount + syncedCount}<br>
                <strong>קורסים ייחודיים שנבחרו:</strong> ${uniqueCourses.size}
            `;
        }

        // פונקציה להצגת מידע דיבאג
        function showDebugInfo() {
            const debugDiv = document.getElementById('debugInfo');
            let html = '<h4>מידע דיבאג:</h4>';
            html += '<pre>';
            
            Object.keys(selectedCourses).forEach(key => {
                const [time, day] = key.split('_');
                const course = selectedCourses[key];
                html += `${day} ${time}: ${course.course} (${course.variant}) - ${course.teacher} [${course.manual ? 'ידני' : 'סנכרון'}]\n`;
            });
            
            html += '</pre>';
            debugDiv.innerHTML = html;
        }

        // פונקציה לניקוי בחירות
        function clearAllSelections() {
            selectedCourses = {};
            document.querySelectorAll('select').forEach(select => {
                select.value = '';
                select.className = '';
            });
            updateStats();
            document.getElementById('debugInfo').innerHTML = '';
        }

        // פונקציה לייצוא לאקסל
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const data = [];
            
            Object.keys(fullScheduleData).forEach(time => {
                const row = { 'שעה': time };
                
                const dayNames = {
                    'א': 'יום ראשון',
                    'ב': 'יום שני',
                    'ג': 'יום שלישי',
                    'ד': 'יום רביעי',
                    'ה': 'יום חמישי',
                    'ו': 'יום שישי'
                };
                
                ['א', 'ב', 'ג', 'ד', 'ה', 'ו'].forEach(day => {
                    const key = `${time}_${day}`;
                    if (selectedCourses[key]) {
                        const course = selectedCourses[key];
                        row[dayNames[day]] = course.teacher ? 
                            `${course.course} (${course.variant}) - ${course.teacher}` :
                            `${course.course} (${course.variant})`;
                    } else {
                        row[dayNames[day]] = '';
                    }
                });
                
                data.push(row);
            });
            
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "מערכת שעות");
            XLSX.writeFile(wb, "מערכת_שעות_נבחרת.xlsx");
        }

        // הגדרת event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('processBtn').addEventListener('click', function() {
                createScheduleTable();
                document.getElementById('output').style.display = 'block';
                document.getElementById('clearBtn').style.display = 'inline-block';
                document.getElementById('exportBtn').style.display = 'inline-block';
                document.getElementById('debugBtn').style.display = 'inline-block';
                document.querySelector('.legend').style.display = 'flex';
                document.getElementById('stats').style.display = 'block';
                updateStats();
            });
            
            document.getElementById('clearBtn').addEventListener('click', clearAllSelections);
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
            document.getElementById('debugBtn').addEventListener('click', function() {
                const debugDiv = document.getElementById('debugInfo');
                debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
                showDebugInfo();
            });
            
            console.log("מערכת מוכנה - גרסה מתוקנת עם סנכרון משופר!");
        });
    </script>
</body>
</html>
